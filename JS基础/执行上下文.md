# 执行上下文

## 概念
执行上下文（execution context 简称 EC）即代码运行的环境，每当JS运行时，都是在执行上下文中运行的。主要记录了代码执行过程中的状态信息，如：
- 变量对象的定义
- 作用域链的扩展
- 提供调用者的对象引用等信息

代码结束时，执行上下文也会销毁。

## 执行上下文栈 & Event Loop执行机制
- 执行栈（call stack）是用来存放不同执行上下文的栈结构（LIFO后进先出），因为脚本运行时可能会调用很多函数而产生很多函数执行上下文，统一交由执行栈管理。
- 执行栈的容量是有限的，如果积压到一定程度继续积压，会报“栈溢出”（stack overflow）错误。栈溢出错误常发生在递归（调用自身）中。
- Event Loop事件循环是JS的执行机制。因为js引擎线程是单线程的，为了合理地安排同步任务和异步任务的执行，定义了事件循环机制来协调。Event Loop会先执行完处于执行栈中的任务后，然后从事件队列读取事件，添加到执行栈中执行，如此循环。

## 执行上下文分类
根据不同的运行场景，执行上下文分为：
- 全局执行上下文
  - js代码开始的默认运行环境，在整个js脚本的生命周期中一直存在于执行堆栈的最底部不会被栈弹出销毁
  - 全局上下文会生成一个全局对象（浏览器中是window，node中是global）
  - 将this指向全局对象
- 函数执行上下文
  - 函数调用时创建
  - 不管函数调用几次，每次调用都会生成新的上下文
- eval执行上下文
  - eval函数执行时，会有属于它自己的执行上下文

## 执行上下文生命周期
### 创建阶段
- 初始化变量对象
  - 如果是函数执行上下文，会以参数列表(arguments)初始化变量对象，以及将函数内部的变量声明、函数声明添加到变量对象。
  - 在这一阶段，会进行变量和函数的初始化声明，变量定义为undefined，而函数直接定义。即变量提升，变量和函数都会提升，但函数会更靠前。
```javascript
  //变量提升中，函数更靠前,所以会被同名的变量覆盖
  var a = 2
  function a(){
  }
  console.log(a); //2
```
- 构建作用域链
- 确定this值

### 执行阶段
JS代码开始逐句执行，顺着作用域链访问变量、为之前声明的变量赋值、碰到函数调用则创建新的函数执行上下文压入栈中，并把控制权交出。

### 销毁阶段
一般情况下，函数执行完成后，会将当前上下文弹出执行栈进行销毁，将控制权交回给上一层的执行上下文。但是闭包的情况有所不同。

当包裹闭包函数的父函数执行完毕后，父函数本身执行环境的作用域链被销毁，但是由于闭包函数有对父函数变量的引用，导致父函数的变量对象一直存在于内存，无法被销毁，除非闭包的引用被删除。

过多使用闭包导致不再用到的内存，没有及时释放，有可能发生“内存泄露”。